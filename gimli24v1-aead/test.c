#include <stdio.h>
#include "gimli.h"
#include "hal.h"

#define MSGLEN 31
#define ADLEN 24

char outstr[128];

const unsigned char key[CRYPTO_KEYBYTES] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b,
    0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
    0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f
};

const unsigned char nonce[CRYPTO_NPUBBYTES] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b,
    0x0c, 0x0d, 0x0e, 0x0f
};

const unsigned char msg[MSGLEN] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b,
    0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
    0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e
};

const unsigned char ad[ADLEN] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b,
    0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17
};

const unsigned char cmp[MSGLEN+CRYPTO_ABYTES] = {
    0x0f, 0x17, 0x81, 0x90, 0x37, 0xc9, 0x54, 0x31, 0xd1, 0x74, 0x58, 0x4b,
    0xf3, 0xb8, 0x17, 0xf5, 0xe7, 0xd6, 0x7b, 0x6f, 0xec, 0x3a, 0x1b, 0xbb,
    0x66, 0xd9, 0xa0, 0x63, 0x20, 0x77, 0x1f, 0x91, 0xf0, 0x6d, 0x92, 0xaf,
    0xdd, 0x60, 0x7e, 0x93, 0x8a, 0x27, 0x4a, 0x90, 0x52, 0x97, 0xd5
};


static void fail(void)
{
    hal_send_str("Test failed!\n");
    while(1);
}

int main(void)
{
  unsigned char ct[MSGLEN + CRYPTO_ABYTES] = {0};
  unsigned char msg2[MSGLEN+CRYPTO_ABYTES] = {0};
  unsigned long long clen;
  unsigned long long mlen2;
  int rc, i;

  const unsigned char random[48] = {1};

  //clock
  hal_setup(CLOCK_FAST);

  hal_send_str("\n\r============ IGNORE OUTPUT BEFORE THIS LINE ============\n\r");

  rc = crypto_aead_encrypt_shared(ct, &clen, msg, MSGLEN, ad, ADLEN, NULL, nonce, key, random);

  if(rc) fail();
  if(clen != MSGLEN + CRYPTO_ABYTES) fail();
  
  for(i=0;i<6;i++)
  {
    sprintf(outstr, "%d\t%d\t%d\t%d\t%d\t%d\t%d\t%d\r", ct[8*i], ct[8*i+1], ct[8*i+2], ct[8*i+3], ct[8*i+4], ct[8*i+5], ct[8*i+6], ct[8*i+7]);
    hal_send_str(outstr);
  }
  
  for(i=0;i<MSGLEN + CRYPTO_ABYTES;i++)
  {
    if(cmp[i] != ct[i]) fail();
  }

  rc = crypto_aead_decrypt(msg2, &mlen2, NULL, ct, clen, ad, ADLEN, nonce, key);

  if(rc) fail();
  if(mlen2 != MSGLEN) fail();

  for(i=0;i<MSGLEN;i++)
  {
    if(msg[i] != msg2[i]) fail();
  }

  hal_send_str("Test successful!\n\r");
  while(1);
  return 0;
}
